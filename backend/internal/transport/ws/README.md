# WebSocket Server Structure

Этот пакет содержит WebSocket сервер для X-Cells с разделенной архитектурой.

## Структура файлов

### Основные файлы
- `server.go` - Основной WebSocket сервер и обработка соединений
- `safe_writer.go` - Потокобезопасная обертка для WebSocket соединений
- `serializer.go` - Сериализация и отправка данных клиентам
- `types.go` - Типы сообщений и структуры данных
- `messages.go` - Создание различных типов сообщений

### Модули функциональности
- `player_manager.go` - Управление игроками (создание, удаление, ID генерация)
- `control_handler.go` - Обработка команд управления и физических импульсов
- `network_simulation.go` - Имитация сетевых условий (задержки, потери пакетов)

## Основные компоненты

### PlayerManager
- Создание уникальных игроков с случайными позициями и радиусами (2.0-20.0)
- Адаптивная масса в зависимости от размера сферы
- Генерация уникальных ID для игроков и их объектов
- Очередь создания игроков для избежания гонок при множественных подключениях

### ControlHandler
- Обработка команд MOUSE_VECTOR, LEFT, RIGHT, UP, DOWN, SPACE
- Адаптивные физические импульсы в зависимости от размера сферы
- Увеличенная частота применения импульсов (40 Hz вместо 20 Hz)
- Применение физических импульсов через Bullet Physics
- Периодическое применение сил на основе состояния контроллеров
- Обработка ping/pong сообщений

### NetworkSimulation
- Имитация задержек сети
- Имитация потери пакетов
- Ограничение пропускной способности

## Особенности

### Случайные радиусы игроков
Каждый новый игрок получает случайный радиус от 2.0 до 20 единиц для разнообразия.

### Масштабируемость
- Очередь создания игроков предотвращает проблемы "Too many open files"
- Поддержка множественных ботов (протестировано до 15+ одновременно)

### Физика
- Интеграция с Bullet Physics сервером
- Без ограничений скорости для максимальной свободы движения
- Поддержка как клиентской (Ammo.js), так и серверной (Bullet) физики

## Настройки отзывчивости

### Улучшенные настройки физики
- **Базовый импульс**: увеличен с 30.0 до 80.0 для быстрой реакции
- **Максимальный импульс**: увеличен с 160.0 до 400.0 для мощных векторов
- **Частота импульсов**: увеличена с 20 Hz до 40 Hz
- **Масса игроков**: уменьшена и адаптивна к размеру сферы
- **Трение**: минимизировано (0.01) для плавного движения
- **Затухание**: полностью убрано для мгновенной реакции

### Адаптивная система
- Большие сферы получают пропорционально больший импульс
- Масса рассчитывается исходя из объема сферы
- Множитель размера от 0.8 до 1.2 для сбалансированного управления

# WebSocket Transport Layer

Пакет `ws` предоставляет компоненты для работы с WebSocket-соединениями в X-Cells.

## Компоненты

### SafeWriter

`SafeWriter` - потокобезопасная обертка для WebSocket соединения, которая позволяет безопасно писать 
в соединение из нескольких горутин, что устраняет проблему с concurrent writes.

Пример использования:

```go
// Создание потокобезопасного райтера
conn, _ := upgrader.Upgrade(w, r, nil)
safeWriter := ws.NewSafeWriter(conn)
defer safeWriter.Close()

// Безопасная отправка JSON данных
data := map[string]interface{}{
    "type": "update",
    "id": "obj1",
}
safeWriter.WriteJSON(data)
```

### WSServer

`WSServer` - сервер WebSocket, который обрабатывает соединения и управляет обменом данными.

Пример использования:

```go
// Создание сервера
server := ws.NewWSServer(worldManager, physicsClient)

// Регистрация обработчика
http.HandleFunc("/ws", server.HandleWS)
```

### Типы сообщений

Пакет также определяет структуры для различных типов сообщений:

- `ObjectMessage` - сообщения о создании и обновлении объектов
- `CommandMessage` - команды от клиента
- `AckMessage` - подтверждения команд
- `PingMessage` / `PongMessage` - измерение задержки
- `InfoMessage` - информационные сообщения

## Преимущества

1. **Потокобезопасность** - предотвращение ошибок concurrent write
2. **Типизированные сообщения** - строгое определение формата сообщений
3. **Константы** - предотвращение ошибок с использованием строковых литералов
4. **Модульная архитектура** - легкость тестирования и повторного использования 