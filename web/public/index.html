<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>X-Cells</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { width: 100%; height: 100%; overflow: hidden; position: fixed; }
        canvas { display: block; width: 100%; height: 100%; }
    </style>
</head>
<body>
    <script>
        // Создаем глобальное пространство имен для нашего приложения
        window.XCells = {
            isAmmoReady: false,
            onAmmoReady: [],  // Массив колбэков для выполнения после инициализации
            debug: true       // Включаем отладочные сообщения
        };

        // Функция для регистрации колбэков
        window.XCells.registerAmmoCallback = function(callback) {
            if (window.XCells.isAmmoReady) {
                callback();
            } else {
                window.XCells.onAmmoReady.push(callback);
            }
        };

        // Функция для проверки доступности Ammo.js
        function checkAmmo() {
            const ammo = window.Ammo || window.AmmoLib;
            if (window.XCells.debug) {
                console.log('[Physics] Проверка Ammo.js:', {
                    windowAmmo: typeof window.Ammo,
                    windowAmmoLib: typeof window.AmmoLib,
                    isReady: window.XCells.isAmmoReady
                });
            }
            return ammo;
        }

        // Функция для загрузки Ammo.js
        function loadAmmo() {
            return new Promise((resolve, reject) => {
                // Проверяем, не загружен ли уже Ammo.js
                if (checkAmmo()) {
                    console.log('[Physics] Ammo.js уже загружен');
                    window.XCells.isAmmoReady = true;
                    resolve(window.Ammo || window.AmmoLib);
                    return;
                }

                console.log('[Physics] Начало загрузки Ammo.js...');
                const script = document.createElement('script');
                script.src = '/ammo/ammo.wasm.js';
                script.async = true;
                
                script.onload = () => {
                    console.log('[Physics] Скрипт Ammo.js загружен, ожидание инициализации...');
                    
                    if (typeof Ammo === 'function') {
                        console.log('[Physics] Ammo.js найден, начало инициализации...');
                        Ammo()
                            .then(AmmoLib => {
                                console.log('[Physics] Ammo.js успешно инициализирован');
                                window.Ammo = AmmoLib;
                                window.AmmoLib = AmmoLib;
                                window.XCells.isAmmoReady = true;
                                
                                // Вызываем все зарегистрированные колбэки
                                while (window.XCells.onAmmoReady.length > 0) {
                                    const callback = window.XCells.onAmmoReady.shift();
                                    try {
                                        callback();
                                    } catch (error) {
                                        console.error('[Physics] Ошибка в колбэке:', error);
                                    }
                                }
                                
                                resolve(AmmoLib);
                            })
                            .catch(error => {
                                console.error('[Physics] Ошибка инициализации Ammo.js:', error);
                                reject(error);
                            });
                    } else {
                        const error = new Error('[Physics] Ammo.js не найден после загрузки скрипта');
                        console.error(error);
                        reject(error);
                    }
                };
                
                script.onerror = (error) => {
                    console.error('[Physics] Ошибка загрузки скрипта Ammo.js:', error);
                    reject(error);
                };
                
                document.head.appendChild(script);
            });
        }

        // Загружаем приложение
        function loadApp() {
            console.log('[App] Загрузка основного приложения...');
            console.log('[App] Состояние Ammo перед загрузкой bundle.js:', {
                Ammo: typeof window.Ammo,
                AmmoLib: typeof window.AmmoLib,
                isReady: window.XCells.isAmmoReady
            });
            
            const script = document.createElement('script');
            script.src = 'bundle.js';
            document.body.appendChild(script);
        }

        // Основная последовательность загрузки
        window.addEventListener('DOMContentLoaded', async () => {
            try {
                console.log('[App] Начало загрузки Ammo.js...');
                await loadAmmo();
                console.log('[App] Ammo.js успешно загружен и инициализирован');
                
                // Дополнительная проверка перед загрузкой приложения
                if (!checkAmmo()) {
                    throw new Error('Ammo.js не инициализирован после загрузки');
                }
                
                loadApp();
            } catch (error) {
                console.warn('[App] Запуск приложения без физики:', error);
                loadApp();
            }
        });
    </script>
</body>
</html>