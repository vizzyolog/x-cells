<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>X-Cells</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { width: 100%; height: 100%; overflow: hidden; position: fixed; }
        canvas { display: block; width: 100%; height: 100%; }
        
        /* Стили для экрана загрузки */
        #loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #111;
            color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 100;
        }
        .loading-text {
            font-family: Arial, sans-serif;
            font-size: 24px;
            margin-bottom: 20px;
        }
        .loading-progress {
            width: 300px;
            height: 5px;
            background-color: #333;
            border-radius: 3px;
            overflow: hidden;
        }
        .loading-bar {
            height: 100%;
            width: 0%;
            background-color: #4CAF50;
            transition: width 0.3s;
        }
    </style>
    <!-- Напрямую загружаем стабильную версию Ammo.js -->
    <script src="https://cdn.jsdelivr.net/npm/ammo.js@0.0.10/ammo.js"></script>
</head>
<body>
    <!-- Экран загрузки -->
    <div id="loading-screen">
        <div class="loading-text">Загрузка физического движка...</div>
        <div class="loading-progress">
            <div class="loading-bar" id="loading-bar"></div>
        </div>
    </div>
    
    <script>
        // Функция обновления прогресса загрузки
        function updateLoadingProgress(percent) {
            document.getElementById('loading-bar').style.width = percent + '%';
            document.querySelector('.loading-text').textContent = 
                'Загрузка физического движка... ' + Math.round(percent) + '%';
        }
        
        // Загрузка бандла
        function loadBundle() {
            console.log('Загрузка бандла...');
            document.querySelector('.loading-text').textContent = 'Загрузка приложения...';
            
            const script = document.createElement('script');
            script.src = 'bundle.js';
            script.onload = function() {
                console.log('Бандл загружен, скрываем экран загрузки');
                setTimeout(function() {
                    document.getElementById('loading-screen').style.opacity = '0';
                    document.getElementById('loading-screen').style.transition = 'opacity 0.5s';
                    setTimeout(function() {
                        document.getElementById('loading-screen').style.display = 'none';
                    }, 500);
                }, 500);
            };
            
            document.body.appendChild(script);
        }
        
        // Проверяем наличие требуемых методов и добавляем заглушки при необходимости
        function checkAndAddStubs(ammo) {
            console.log('Проверка наличия необходимых конструкторов...');
            
            // Список требуемых конструкторов
            const requiredConstructors = [
                'btHeightfieldTerrainShape',
                'btDefaultCollisionConfiguration',
                'btCollisionDispatcher',
                'btDbvtBroadphase',
                'btSequentialImpulseConstraintSolver',
                'btDiscreteDynamicsWorld',
                'btVector3',
                'btTransform',
                'btSphereShape',
                'btDefaultMotionState',
                'btRigidBodyConstructionInfo',
                'btRigidBody'
            ];
            
            // Проверяем и добавляем заглушки
            requiredConstructors.forEach(name => {
                if (typeof ammo[name] !== 'function') {
                    console.warn(`Конструктор ${name} отсутствует в загруженной версии Ammo.js. Создаем заглушку.`);
                    
                    // Создаем базовую заглушку для btVector3
                    if (name === 'btVector3' && typeof ammo.btVector3 !== 'function') {
                        ammo.btVector3 = function(x, y, z) {
                            this.x = x || 0;
                            this.y = y || 0;
                            this.z = z || 0;
                            this.setValue = function(nx, ny, nz) { this.x = nx; this.y = ny; this.z = nz; };
                            this.x = function() { return this.x; };
                            this.y = function() { return this.y; };
                            this.z = function() { return this.z; };
                        };
                    }
                    
                    // Создаем заглушку для btTransform
                    if (name === 'btTransform' && typeof ammo.btTransform !== 'function') {
                        ammo.btTransform = function() {
                            this.setIdentity = function() {};
                            this.setOrigin = function(vector) { this.origin = vector; };
                            this.getOrigin = function() { return this.origin || new ammo.btVector3(0, 0, 0); };
                            this.setRotation = function(quat) { this.rotation = quat; };
                            this.getRotation = function() { 
                                return this.rotation || {x: function() { return 0; }, 
                                                        y: function() { return 0; }, 
                                                        z: function() { return 0; },
                                                        w: function() { return 1; }}; 
                            };
                        };
                    }
                    
                    // Заглушка для btHeightfieldTerrainShape (ключевая для текущей ошибки)
                    if (name === 'btHeightfieldTerrainShape' && typeof ammo.btHeightfieldTerrainShape !== 'function') {
                        ammo.btHeightfieldTerrainShape = function(width, length, heightData, scale, minHeight, maxHeight, upAxis, flipQuadEdges) {
                            console.log('Использована заглушка для btHeightfieldTerrainShape');
                            // Создаем базовую форму, которая будет работать с остальным кодом
                            this.setLocalScaling = function(scaling) {};
                            this.calculateLocalInertia = function(mass, inertia) {};
                            
                            // Сохраняем параметры для возможного использования
                            this.width = width;
                            this.length = length;
                            this.heightData = heightData;
                            this.scale = scale;
                            this.minHeight = minHeight;
                            this.maxHeight = maxHeight;
                            this.upAxis = upAxis;
                            this.flipQuadEdges = flipQuadEdges;
                        };
                    }
                    
                    // Заглушки для других конструкторов при необходимости
                    if (name === 'btDefaultCollisionConfiguration' && typeof ammo.btDefaultCollisionConfiguration !== 'function') {
                        ammo.btDefaultCollisionConfiguration = function() {};
                    }
                    
                    if (name === 'btCollisionDispatcher' && typeof ammo.btCollisionDispatcher !== 'function') {
                        ammo.btCollisionDispatcher = function(config) {
                            this.config = config;
                        };
                    }
                    
                    if (name === 'btDbvtBroadphase' && typeof ammo.btDbvtBroadphase !== 'function') {
                        ammo.btDbvtBroadphase = function() {};
                    }
                    
                    if (name === 'btSequentialImpulseConstraintSolver' && typeof ammo.btSequentialImpulseConstraintSolver !== 'function') {
                        ammo.btSequentialImpulseConstraintSolver = function() {};
                    }
                    
                    if (name === 'btDiscreteDynamicsWorld' && typeof ammo.btDiscreteDynamicsWorld !== 'function') {
                        ammo.btDiscreteDynamicsWorld = function(dispatcher, broadphase, solver, collisionConfig) {
                            this.dispatcher = dispatcher;
                            this.broadphase = broadphase;
                            this.solver = solver;
                            this.collisionConfig = collisionConfig;
                            this.setGravity = function(gravity) {};
                            this.addRigidBody = function(body) {};
                            this.stepSimulation = function(timeStep, maxSubSteps, fixedTimeStep) {};
                        };
                    }
                    
                    if (name === 'btSphereShape' && typeof ammo.btSphereShape !== 'function') {
                        ammo.btSphereShape = function(radius) {
                            this.radius = radius;
                            this.setLocalScaling = function(scaling) {};
                            this.calculateLocalInertia = function(mass, inertia) {};
                        };
                    }
                    
                    if (name === 'btDefaultMotionState' && typeof ammo.btDefaultMotionState !== 'function') {
                        ammo.btDefaultMotionState = function(transform) {
                            this.transform = transform;
                            this.getWorldTransform = function(trans) { 
                                if (trans && this.transform) {
                                    Object.assign(trans, this.transform);
                                }
                                return this.transform; 
                            };
                            this.setWorldTransform = function(trans) { this.transform = trans; };
                        };
                    }
                    
                    if (name === 'btRigidBodyConstructionInfo' && typeof ammo.btRigidBodyConstructionInfo !== 'function') {
                        ammo.btRigidBodyConstructionInfo = function(mass, motionState, shape, localInertia) {
                            this.mass = mass;
                            this.motionState = motionState;
                            this.shape = shape;
                            this.localInertia = localInertia;
                        };
                    }
                    
                    if (name === 'btRigidBody' && typeof ammo.btRigidBody !== 'function') {
                        ammo.btRigidBody = function(constructionInfo) {
                            this.constructionInfo = constructionInfo;
                            this.setRestitution = function(r) {};
                            this.setFriction = function(f) {};
                            this.setRollingFriction = function(rf) {};
                            this.activate = function(forceActivation) {};
                            this.setCollisionFlags = function(flags) {};
                            this.getMotionState = function() { return this.constructionInfo.motionState; };
                            this.setCenterOfMassTransform = function(transform) {};
                            this.setLinearVelocity = function(velocity) {};
                            this.setAngularVelocity = function(velocity) {};
                            this.getLinearVelocity = function() { return new ammo.btVector3(0, 0, 0); };
                            this.isActive = function() { return true; };
                        };
                    }
                } else {
                    console.log(`Конструктор ${name} доступен`);
                }
            });
            
            return ammo;
        }
        
        // Инициализация Ammo.js
        function initAmmo() {
            if (typeof Ammo === 'function') {
                console.log('Ammo загружен как функция, инициализируем');
                return Ammo().then(function(ammo) {
                    console.log('Ammo.js инициализирован успешно');
                    // Проверяем и добавляем заглушки
                    ammo = checkAndAddStubs(ammo);
                    window.AmmoLib = ammo;
                    window.Ammo = ammo;
                    return ammo;
                });
            } else if (typeof Ammo === 'object') {
                console.log('Ammo загружен как объект, используем напрямую');
                // Проверяем и добавляем заглушки
                Ammo = checkAndAddStubs(Ammo);
                window.AmmoLib = Ammo;
                window.Ammo = Ammo;
                return Promise.resolve(Ammo);
            } else {
                console.error('Ammo не найден в глобальном объекте');
                return Promise.reject(new Error('Ammo не найден'));
            }
        }
        
        // Создание тестового физического мира
        function createTestPhysicsWorld(ammo) {
            try {
                console.log('Создание тестового физического мира...');
                
                // Проверяем наличие необходимых конструкторов
                if (typeof ammo.btDefaultCollisionConfiguration !== 'function' ||
                    typeof ammo.btCollisionDispatcher !== 'function' ||
                    typeof ammo.btDbvtBroadphase !== 'function' ||
                    typeof ammo.btSequentialImpulseConstraintSolver !== 'function' ||
                    typeof ammo.btDiscreteDynamicsWorld !== 'function' ||
                    typeof ammo.btVector3 !== 'function') {
                    console.warn('Отсутствуют необходимые конструкторы для создания физического мира');
                    return false;
                }
                
                const collisionConfig = new ammo.btDefaultCollisionConfiguration();
                const dispatcher = new ammo.btCollisionDispatcher(collisionConfig);
                const broadphase = new ammo.btDbvtBroadphase();
                const solver = new ammo.btSequentialImpulseConstraintSolver();
                const world = new ammo.btDiscreteDynamicsWorld(
                    dispatcher, 
                    broadphase, 
                    solver, 
                    collisionConfig
                );
                
                world.setGravity(new ammo.btVector3(0, -9.81, 0));
                window.physicsWorld = world;
                
                console.log('Тестовый физический мир создан успешно');
                return true;
            } catch (error) {
                console.error('Ошибка при создании тестового физического мира:', error);
                return false;
            }
        }
        
        // Запуск при загрузке страницы
        window.addEventListener('load', function() {
            console.log('Страница загружена, инициализируем Ammo.js');
            updateLoadingProgress(30);
            
            // Проверяем загрузку Ammo.js
            if (typeof Ammo === 'undefined') {
                console.log('Ammo не загружен, загружаем локальную версию');
                const script = document.createElement('script');
                script.src = 'ammo/ammo.wasm.js';
                script.onload = continueLoading;
                script.onerror = function() {
                    console.error('Не удалось загрузить Ammo.js');
                    loadBundle(); // Всё равно пытаемся загрузить бандл
                };
                document.head.appendChild(script);
            } else {
                continueLoading();
            }
            
            function continueLoading() {
                updateLoadingProgress(60);
                
                initAmmo()
                    .then(function(ammo) {
                        // Проверяем успешность инициализации Ammo
                        console.log('Объект Ammo доступен:', !!window.Ammo);
                        console.log('Объект AmmoLib доступен:', !!window.AmmoLib);
                        
                        // Защита для checkIsAmmoLoaded
                        window.checkIsAmmoLoaded = function() { return true; };
                        
                        // Создаем тестовый физический мир
                        const worldCreated = createTestPhysicsWorld(ammo);
                        console.log('Тестовый физический мир создан:', worldCreated);
                        
                        // Дополнительная проверка нужных методов
                        const hasHeightfield = typeof ammo.btHeightfieldTerrainShape === 'function';
                        console.log('btHeightfieldTerrainShape доступен:', hasHeightfield);
                        
                        updateLoadingProgress(100);
                        loadBundle();
                    })
                    .catch(function(error) {
                        console.error('Ошибка инициализации Ammo.js:', error);
                        // Создаем пустые заглушки для критических объектов
                        window.Ammo = window.Ammo || {};
                        window.AmmoLib = window.AmmoLib || window.Ammo;
                        window.checkIsAmmoLoaded = function() { return true; };
                        
                        // Всё равно пытаемся загрузить бандл
                        loadBundle();
                    });
            }
        });
    </script>
</body>
</html>