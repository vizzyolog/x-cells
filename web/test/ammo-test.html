<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Тест Ammo.js</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        
        h1 {
            color: #333;
        }
        
        #console {
            background-color: #000;
            color: #0f0;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            height: 400px;
            overflow-y: auto;
            margin-bottom: 20px;
        }
        
        button {
            background-color: #4CAF50;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin-right: 10px;
        }
        
        button:hover {
            background-color: #45a049;
        }
        
        .error {
            color: #ff6b6b;
        }
        
        .success {
            color: #4CAF50;
        }
        
        .info {
            color: #2196F3;
        }
        
        .warning {
            color: #ff9800;
        }
    </style>
</head>
<body>
    <h1>Тест Ammo.js</h1>
    <div id="console"></div>
    <button id="run-test">Запустить тест</button>
    <button id="clear-console">Очистить консоль</button>
    
    <script>
        // Перенаправляем вывод консоли в наш элемент
        const consoleElement = document.getElementById('console');
        
        // Сохраняем оригинальные методы консоли
        const originalConsole = {
            log: console.log,
            error: console.error,
            warn: console.warn,
            info: console.info
        };
        
        // Функция для добавления сообщения в консоль
        function addToConsole(message, type = 'log') {
            const line = document.createElement('div');
            line.className = type;
            line.textContent = message;
            consoleElement.appendChild(line);
            consoleElement.scrollTop = consoleElement.scrollHeight;
        }
        
        // Переопределяем методы консоли
        console.log = function(...args) {
            const message = args.map(arg => 
                typeof arg === 'object' ? JSON.stringify(arg) : String(arg)
            ).join(' ');
            addToConsole(message, 'log');
            originalConsole.log.apply(console, args);
        };
        
        console.error = function(...args) {
            const message = args.map(arg => 
                typeof arg === 'object' ? JSON.stringify(arg) : String(arg)
            ).join(' ');
            addToConsole(message, 'error');
            originalConsole.error.apply(console, args);
        };
        
        console.warn = function(...args) {
            const message = args.map(arg => 
                typeof arg === 'object' ? JSON.stringify(arg) : String(arg)
            ).join(' ');
            addToConsole(message, 'warning');
            originalConsole.warn.apply(console, args);
        };
        
        console.info = function(...args) {
            const message = args.map(arg => 
                typeof arg === 'object' ? JSON.stringify(arg) : String(arg)
            ).join(' ');
            addToConsole(message, 'info');
            originalConsole.info.apply(console, args);
        };
        
        // Функция для загрузки Ammo.js
        function loadAmmo() {
            return new Promise((resolve, reject) => {
                console.log('Загрузка Ammo.js...');
                
                // Проверяем, загружен ли уже Ammo.js
                if (typeof Ammo !== 'undefined' && window.AmmoLib) {
                    console.log('Ammo.js уже загружен и инициализирован');
                    resolve(window.AmmoLib);
                    return;
                }
                
                // Используем конкретную версию вместо @latest
                const urls = [
                    './js/libs/ammo.wasm.js',       // Основная версия
                    'https://cdnjs.cloudflare.com/ajax/libs/ammo.js/2.0.0/ammo.js',      // Альтернативный CDN
                    '../ammo.js'                                                          // Локальная копия (если есть)
                ];
                
                let loaded = false;
                
                // Попытка загрузить скрипт из разных источников
                function tryLoadScript(index) {
                    if (index >= urls.length) {
                        console.error('Не удалось загрузить Ammo.js ни из одного источника');
                        reject(new Error('Все источники Ammo.js недоступны'));
                        return;
                    }
                    
                    const script = document.createElement('script');
                    script.src = './js/libs/ammo.wasm.js';
                    console.log(`Попытка загрузки Ammo.js из: ${urls[index]}`);
                    
                    script.onload = () => {
                        console.log(`Скрипт Ammo.js загружен из: ${urls[index]}`);
                        loaded = true;
                        
                        // Проверяем, доступен ли Ammo
                        if (typeof Ammo === 'undefined') {
                            console.error('Ammo не найден после загрузки скрипта');
                            tryLoadScript(index + 1);
                            return;
                        }
                        
                        // Инициализируем Ammo
                        try {
                            Ammo().then(ammoLib => {
                                console.log('Ammo.js инициализирован успешно');
                                window.AmmoLib = ammoLib;
                                resolve(ammoLib);
                            }).catch(error => {
                                console.error('Ошибка инициализации Ammo.js:', error);
                                tryLoadScript(index + 1);
                            });
                        } catch (error) {
                            console.error('Ошибка при вызове Ammo():', error);
                            tryLoadScript(index + 1);
                        }
                    };
                    
                    script.onerror = (error) => {
                        console.error(`Ошибка загрузки скрипта из ${urls[index]}:`, error);
                        tryLoadScript(index + 1);
                    };
                    
                    document.head.appendChild(script);
                }
                
                // Начинаем с первого URL
                tryLoadScript(0);
            });
        }
        
        // Функция для тестирования Ammo.js
        async function testAmmo() {
            try {
                console.log('Начало теста Ammo.js');
                
                // Загружаем Ammo.js
                const AmmoLib = await loadAmmo();
                console.log('AmmoLib получен:', typeof AmmoLib);
                
                // Создаем физический мир
                console.log('Создание физического мира...');
                const collisionConfiguration = new AmmoLib.btDefaultCollisionConfiguration();
                const dispatcher = new AmmoLib.btCollisionDispatcher(collisionConfiguration);
                const broadphase = new AmmoLib.btDbvtBroadphase();
                const solver = new AmmoLib.btSequentialImpulseConstraintSolver();
                const physicsWorld = new AmmoLib.btDiscreteDynamicsWorld(
                    dispatcher,
                    broadphase,
                    solver,
                    collisionConfiguration
                );
                
                console.log('Физический мир создан успешно');
                
                // Устанавливаем гравитацию
                physicsWorld.setGravity(new AmmoLib.btVector3(0, -9.81, 0));
                
                // Создаем сферу
                const radius = 1;
                const sphereShape = new AmmoLib.btSphereShape(radius);
                
                // Создаем transform
                const transform = new AmmoLib.btTransform();
                transform.setIdentity();
                transform.setOrigin(new AmmoLib.btVector3(0, 10, 0));
                
                // Создаем rigid body
                const mass = 1;
                const localInertia = new AmmoLib.btVector3(0, 0, 0);
                sphereShape.calculateLocalInertia(mass, localInertia);
                
                const motionState = new AmmoLib.btDefaultMotionState(transform);
                const rbInfo = new AmmoLib.btRigidBodyConstructionInfo(mass, motionState, sphereShape, localInertia);
                const body = new AmmoLib.btRigidBody(rbInfo);
                
                // Добавляем тело в мир
                physicsWorld.addRigidBody(body);
                
                console.log('Сфера добавлена в мир');
                
                // Симулируем несколько шагов
                for (let i = 0; i < 10; i++) {
                    physicsWorld.stepSimulation(1/60, 1);
                    
                    const trans = new AmmoLib.btTransform();
                    body.getMotionState().getWorldTransform(trans);
                    const pos = trans.getOrigin();
                    
                    console.log(`Шаг ${i}: позиция сферы: y = ${pos.y().toFixed(2)}`);
                }
                
                // Очищаем ресурсы
                physicsWorld.removeRigidBody(body);
                AmmoLib.destroy(body);
                AmmoLib.destroy(motionState);
                AmmoLib.destroy(rbInfo);
                AmmoLib.destroy(localInertia);
                AmmoLib.destroy(sphereShape);
                AmmoLib.destroy(transform);
                AmmoLib.destroy(physicsWorld);
                AmmoLib.destroy(solver);
                AmmoLib.destroy(broadphase);
                AmmoLib.destroy(dispatcher);
                AmmoLib.destroy(collisionConfiguration);
                
                console.log('Тест успешно завершен');
                return true;
            } catch (error) {
                console.error('Ошибка при тестировании Ammo.js:', error);
                return false;
            }
        }
        
        // Обработчики кнопок
        document.getElementById('run-test').addEventListener('click', () => {
            testAmmo().then(success => {
                if (success) {
                    console.info('Тест Ammo.js успешно пройден!');
                } else {
                    console.error('Тест Ammo.js не пройден!');
                }
            });
        });
        
        document.getElementById('clear-console').addEventListener('click', () => {
            consoleElement.innerHTML = '';
        });
        
        // Выводим информацию при загрузке страницы
        console.info('Страница загружена. Нажмите "Запустить тест" для проверки Ammo.js');
    </script>
</body>
</html> 